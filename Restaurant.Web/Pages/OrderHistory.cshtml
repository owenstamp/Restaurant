@page
@model OrderHistoryModel
@{
    Layout = "_Layout";
    var role = HttpContext.Session.GetString("UserRole") ?? "";
}

@if (role != "Manager" && role != "Waitstaff")
{
    <h2>Access Denied</h2>
    <p>You do not have permission to view this page.</p>
    return;
}

<section class="order-history-section">
    <h2>Order History</h2>

    <table class="styled-table">
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Date</th>
                <th>Status</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in Model.PastOrders)
            {
                <tr>
                    <td>@order.Id</td>
                    <td>@order.OrderDateTime.ToLocalTime().ToString("g")</td>
                    <td>@order.Status</td>
                    <td>@order.TotalAmount.ToString("C")</td>
                    <td>
                        <button type="button" onclick="openModal('@order.Id')">View</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</section>

<!-- Order Detail Modal -->
<div id="orderModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        @if (Model.SelectedOrder != null)
        {
            <h3>Order Details – @Model.SelectedOrder.Id</h3>
            <p><strong>Status:</strong> @Model.SelectedOrder.Status</p>
            <p><strong>Date:</strong> @Model.SelectedOrder.OrderDateTime.ToLocalTime().ToString("f")</p>
            <p><strong>Total:</strong> @Model.SelectedOrder.TotalAmount.ToString("C")</p>

            <h4>Items:</h4>
            <ul>
                @foreach (var item in Model.SelectedOrder.Items)
                {
                    <li>
                        @item.Quantity x @(Model.MenuItemNames.ContainsKey(item.MenuItemId)
                ? Model.MenuItemNames[item.MenuItemId]
                : "Unknown")
                        @($" @ {item.Price.ToString("C")}")
                    </li>
                }
            </ul>
        }
        else
        {
            <p>Unable to load order details.</p>
        }
    </div>
</div>

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .modal-content {
        background: white;
        margin: 10% auto;
        padding: 1.5rem;
        width: 60%;
        border-radius: 8px;
    }

    .close-btn {
        float: right;
        font-size: 1.2rem;
        cursor: pointer;
    }
</style>

<script>
    function openModal(orderId) {
        const url = `?selectedOrderId=${orderId}`;
        window.location.href = url;
    }

    function closeModal() {
        document.getElementById("orderModal").style.display = "none";
    }

    // Auto-show modal if there's a selected order
    window.onload = function () {
        if ('@Model.SelectedOrder' !== '') {
            document.getElementById("orderModal").style.display = "block";
        }
    }
</script>
